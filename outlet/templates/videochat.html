<!DOCTYPE html>
<html>
<head>
    <title>Video Chat</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(120deg, #e0f7fa, #e1bee7);
            padding: 40px;
            display: flex;
            justify-content: center;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 750px;
            text-align: center;
        }

        h2, h4 {
            margin: 5px;
            color: #333;
        }

        video {
            width: 45%;
            margin: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            transition: width 0.2s;
        }

        button {
            margin-top: 6px;
            padding: 10px;
            width: 40%;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
        }

        .end-call {
            background: #e53935;
            width: 100%;
            margin-top: 20px;
        }

        .size-controls {
            display: flex;
            justify-content: space-around;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
<div class="container">

    <h2>Video Call Room</h2>
    <h4>Room: {{ room }}</h4>
    <h4>You: {{ username }}</h4>

    <!-- Local Video -->
    <div>
        <video id="localVideo" autoplay muted></video>
        <div class="size-controls">
            <button id="localIncrease">+ Local</button>
            <button id="localDecrease">âˆ’ Local</button>
        </div>
    </div>

    <!-- Remote Video -->
    <div>
        <video id="remoteVideo" autoplay></video>
        <div class="size-controls">
            <button id="remoteIncrease">+ Remote</button>
            <button id="remoteDecrease">âˆ’ Remote</button>
        </div>
    </div>

    <!-- End Call -->
    <button class="end-call" onclick="endCall()">ðŸ”´ End Call</button>
   

</div>



<script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
<script>
    const socket = io();
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');

    const room = "{{ room }}";
    const username = "{{ username }}";
    const isHost = {{ 'true' if is_host else 'false' }};

    let pc;
    let localStream;

    let localWidth = 45;
    let remoteWidth = 45;

    async function init() {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;

        pc = new RTCPeerConnection();

        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

        pc.ontrack = (event) => {
            remoteVideo.srcObject = event.streams[0];
       };

        pc.onicecandidate = (event) => {
            if (event.candidate) {
                socket.emit('ice_candidate', { candidate: event.candidate, room });
            }
        };

        socket.emit('join', room);

        if (isHost) {
            // Host waits for participants
            socket.on('new_participant', async () => {
                console.log("Participant joined, creating offer...");
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                socket.emit('offer', { offer, room });
            });
        }
    }
    

    init();

    // ---- Signaling ----
    socket.on('offer', async (data) => {
        await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        socket.emit('answer', { answer, room });
    });

    socket.on('answer', async (data) => {
        await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
    });

    socket.on('ice_candidate', async (data) => {
        try {
            await pc.addIceCandidate(data.candidate);
        } catch (e) {
            console.error(e);
        }
    });
    
    // Notify host when participant joins
    if (!isHost) {
        socket.emit('new_participant', room);
    }

    // ---- Resize Controls ----
    document.getElementById('localIncrease').onclick = () => {
        localWidth = Math.min(localWidth + 10, 100);
        localVideo.style.width = localWidth + '%';
    };

    document.getElementById('localDecrease').onclick = () => {
        localWidth = Math.max(localWidth - 10, 20);
        localVideo.style.width = localWidth + '%';
    };

    document.getElementById('remoteIncrease').onclick = () => {
        remoteWidth = Math.min(remoteWidth + 10, 100);
        remoteVideo.style.width = remoteWidth + '%';
    };

    document.getElementById('remoteDecrease').onclick = () => {
        remoteWidth = Math.max(remoteWidth - 10, 20);
        remoteVideo.style.width = remoteWidth + '%';
    };

    // ---- End Call ----
    function endCall() {
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
        }
        if (pc) pc.close();
        socket.emit('leave', room);
        socket.disconnect();
        window.location.href = "/videochat-lobby";
    }
</script>
</body>
</html>
